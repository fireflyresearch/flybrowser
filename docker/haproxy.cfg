# HAProxy Configuration for FlyBrowser Cluster
#
# This configuration provides:
# - HTTP load balancing across FlyBrowser nodes
# - Health checks for automatic failover
# - WebSocket support for real-time features
# - Session affinity (sticky sessions)

global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    option  http-server-close
    timeout connect 10s
    timeout client  300s
    timeout server  300s
    timeout tunnel  3600s

# Stats interface (optional)
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

# Main HTTP frontend
frontend http_front
    bind *:80
    
    # Health check endpoint (no auth required)
    acl is_health path_beg /health
    
    # WebSocket detection
    acl is_websocket hdr(Upgrade) -i websocket
    
    default_backend flybrowser_backend

# FlyBrowser backend
backend flybrowser_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Enable session affinity using cookies
    cookie SERVERID insert indirect nocache
    
    # WebSocket support
    option http-server-close
    option forceclose
    
    # Server definitions with health checks
    server node1 node1:8000 check inter 5s fall 3 rise 2 cookie node1
    server node2 node2:8000 check inter 5s fall 3 rise 2 cookie node2
    server node3 node3:8000 check inter 5s fall 3 rise 2 cookie node3

