<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlyBrowser - Agent {{ "Completed" if success else "Failed" }}</title>
    <!-- Marker for completion page detection -->
    <meta name="flybrowser-completion" content="true">
    <meta name="flybrowser-success" content="{{ 'true' if success else 'false' }}">
    {% if inline_styles %}
    <style>{{ css_content | safe }}</style>
    {% else %}
    <link rel="stylesheet" href="{{ static_url }}/css/completion.css">
    {% endif %}
</head>
<body class="{{ 'success' if success else 'failure' }}">
    <!-- Hidden marker element for page type detection -->
    <div class="flybrowser-completion-page" data-flybrowser-completion="true" data-success="{{ 'true' if success else 'false' }}" style="display:none;">
        FlyBrowser Completion Page - Agent Execution Finished
    </div>
    
    <!-- Matrix rain canvas -->
    <canvas id="matrix-rain"></canvas>
    
    <!-- Ambient glow background -->
    <div class="bg-gradient"></div>
    
    <!-- Main two-column layout -->
    <div class="page-wrapper">
        <div class="two-column-layout">
            <!-- LEFT COLUMN: Status, Task, Metrics, Details -->
            <div class="left-column">
                <!-- Header with status -->
                <div class="column-header">
                    <div class="status-icon-wrapper">
                        {% if success %}
                        <svg class="icon-success" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        {% else %}
                        <svg class="icon-failure" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        {% endif %}
                    </div>
                    <div class="status-text">
                        <h1 class="status-title">{{ "Task Completed" if success else "Task Failed" }}</h1>
                        <div class="status-badge">
                            <div class="status-dot"></div>
                            <span>{{ "Success" if success else "Failed" }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Task Card -->
                <div class="info-card task-card" onclick="toggleTaskExpand(this)">
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                    </div>
                    <div class="card-content">
                        <div class="card-header-row">
                            <div class="card-label">Task Description</div>
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                        <div class="card-value task-text">{{ task }}</div>
                    </div>
                </div>
                
                <!-- Section Divider -->
                <div class="section-divider">
                    <span class="divider-label">Performance Metrics</span>
                </div>
                
                <!-- Metrics Grid -->
                <div class="metrics-grid">
                    <div class="metric-card metric-highlight">
                        <div class="metric-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">{{ duration_formatted }}</div>
                            <div class="metric-label">Total Duration</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                <polyline points="17 6 23 6 23 12"></polyline>
                            </svg>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">
                                {{ iterations }}
                                {% if max_iterations %}
                                <span class="metric-secondary">/ {{ max_iterations }}</span>
                                {% endif %}
                            </div>
                            <div class="metric-label">Iterations</div>
                        </div>
                    </div>
                    {% if llm_usage %}
                    <div class="metric-card">
                        <div class="metric-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">
                                {{ "{:,}".format(llm_usage.total_tokens | default(0) | int) }}
                                <span class="metric-unit">tokens</span>
                            </div>
                            <div class="metric-label">LLM Tokens</div>
                        </div>
                    </div>
                    <div class="metric-card metric-cost">
                        <div class="metric-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">${{ "%.4f" | format(llm_usage.cost_usd | default(0)) }}</div>
                            <div class="metric-label">Estimated Cost</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Section Divider -->
                <div class="section-divider">
                    <span class="divider-label">Execution Details</span>
                </div>
                
                <!-- Expandable Sections -->
                <div class="expandable-sections">
                    {% if llm_usage %}
                    <!-- LLM Usage Details -->
                    <div class="details-section" data-section="llm">
                        <button class="details-toggle" onclick="toggleSection('llm-details')">
                            <div class="toggle-icon-wrapper">
                                <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </div>
                            <div class="toggle-content">
                                <span class="toggle-title">LLM Usage</span>
                                <span class="toggle-subtitle">{{ llm_usage.model | default('unknown') }}</span>
                            </div>
                            <span class="toggle-badge">{{ llm_usage.request_count | default(1) }} calls</span>
                        </button>
                        <div class="details-content" id="llm-details">
                            <div class="details-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Model</span>
                                    <span class="detail-value">{{ llm_usage.model | default('N/A') }}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Provider</span>
                                    <span class="detail-value">{{ llm_usage.provider | default('N/A') }}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Prompt Tokens</span>
                                    <span class="detail-value">{{ "{:,}".format(llm_usage.prompt_tokens | default(0) | int) }}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Completion Tokens</span>
                                    <span class="detail-value">{{ "{:,}".format(llm_usage.completion_tokens | default(0) | int) }}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Total Calls</span>
                                    <span class="detail-value">{{ llm_usage.request_count | default(1) }}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Avg Latency</span>
                                    <span class="detail-value">{{ "%.0f" | format(llm_usage.avg_latency_ms | default(0)) }}ms</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if tools_used and tools_used | length > 0 %}
                    <!-- Tools Executed -->
                    {% set success_count = tools_used | selectattr('success', 'defined') | selectattr('success') | list | length %}
                    {% set fail_count = tools_used | length - success_count %}
                    <div class="details-section expanded" data-section="tools">
                        <button class="details-toggle" onclick="toggleSection('tools-details')">
                            <div class="toggle-icon-wrapper">
                                <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </div>
                            <div class="toggle-content">
                                <span class="toggle-title">Tools Executed</span>
                                <span class="toggle-subtitle">{{ tools_used | length }} tool{{ 's' if tools_used | length != 1 else '' }} called</span>
                            </div>
                            <div class="toggle-badges">
                                {% if success_count > 0 %}
                                <span class="toggle-badge badge-success-sm">{{ success_count }} ✓</span>
                                {% endif %}
                                {% if fail_count > 0 %}
                                <span class="toggle-badge badge-failure-sm">{{ fail_count }} ✗</span>
                                {% endif %}
                            </div>
                        </button>
                        <div class="details-content" id="tools-details">
                            <div class="tools-list">
                                {% for tool in tools_used %}
                                {% if tool %}
                                <div class="tool-item {{ 'tool-success' if tool.get('success', true) else 'tool-failure' }}">
                                    <div class="tool-status-indicator">
                                        {% if tool.get('success', true) %}
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" width="10" height="10">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                        {% else %}
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" width="10" height="10">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                        {% endif %}
                                    </div>
                                    <span class="tool-name">{{ tool.get('name', 'unknown') }}</span>
                                    <span class="tool-duration">
                                        {% set duration = (tool.get('duration_ms', 0) or 0) | int %}
                                        {% if duration >= 1000 %}
                                        {{ "%.1f" | format(duration / 1000) }}s
                                        {% else %}
                                        {{ duration }}ms
                                        {% endif %}
                                    </span>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if reasoning_steps and reasoning_steps | length > 0 %}
                    <!-- Reasoning Steps -->
                    <div class="details-section" data-section="reasoning">
                        <button class="details-toggle" onclick="toggleSection('reasoning-details')">
                            <div class="toggle-icon-wrapper">
                                <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </div>
                            <div class="toggle-content">
                                <span class="toggle-title">Reasoning Steps</span>
                                <span class="toggle-subtitle">Agent thought process</span>
                            </div>
                            <span class="toggle-badge">{{ reasoning_steps | length }} steps</span>
                        </button>
                        <div class="details-content" id="reasoning-details">
                            <div class="steps-timeline">
                                {% for step in reasoning_steps %}
                                {% if step %}
                                <div class="step-item">
                                    <div class="step-connector">
                                        <div class="step-number">{{ loop.index }}</div>
                                        {% if not loop.last %}<div class="step-line"></div>{% endif %}
                                    </div>
                                    <div class="step-content">
                                        <div class="step-thought">{{ step.get('thought', step) if step is mapping else step }}</div>
                                        {% if step is mapping and step.get('action') %}
                                        <div class="step-action">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                                <polyline points="9 18 15 12 9 6"></polyline>
                                            </svg>
                                            <span class="action-name">{{ step.get('action') }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Metadata Footer -->
                {% if metadata %}
                <div class="metadata-bar">
                    <div class="metadata-item">
                        <span class="metadata-label">Session ID</span>
                        <span class="metadata-value" title="{{ metadata.session_id | default('N/A') }}">{{ metadata.session_id | default('N/A') | truncate(12) }}</span>
                    </div>
                    <div class="metadata-divider"></div>
                    <div class="metadata-item">
                        <span class="metadata-label">Strategy</span>
                        <span class="metadata-value">{{ metadata.reasoning_strategy | default('standard') | capitalize }}</span>
                    </div>
                    <div class="metadata-divider"></div>
                    <div class="metadata-item">
                        <span class="metadata-label">Stop Reason</span>
                        <span class="metadata-value">{{ metadata.stop_reason | default('completed') | capitalize }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- RIGHT COLUMN: Result Data (fully expanded) -->
            <div class="right-column">
                {% if success and result_data %}
                <div class="result-panel">
                    <div class="result-header">
                        <div class="result-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <polyline points="16 18 22 12 16 6"></polyline>
                                <polyline points="8 6 2 12 8 18"></polyline>
                            </svg>
                            <span>Result Data</span>
                        </div>
                        <div class="result-actions">
                            <button class="action-btn" onclick="expandAllJson()" title="Expand All">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <polyline points="9 21 3 21 3 15"></polyline>
                                    <line x1="21" y1="3" x2="14" y2="10"></line>
                                    <line x1="3" y1="21" x2="10" y2="14"></line>
                                </svg>
                            </button>
                            <button class="action-btn" onclick="collapseAllJson()" title="Collapse All">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="4 14 10 14 10 20"></polyline>
                                    <polyline points="20 10 14 10 14 4"></polyline>
                                    <line x1="14" y1="10" x2="21" y2="3"></line>
                                    <line x1="3" y1="21" x2="10" y2="14"></line>
                                </svg>
                            </button>
                            <div class="action-divider"></div>
                            <button class="action-btn {{ 'active' }}" onclick="setResultView('tree')" id="btn-tree" title="Tree View">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="3" y1="6" x2="21" y2="6"></line>
                                    <line x1="6" y1="12" x2="21" y2="12"></line>
                                    <line x1="9" y1="18" x2="21" y2="18"></line>
                                </svg>
                            </button>
                            <button class="action-btn" onclick="setResultView('raw')" id="btn-raw" title="Raw JSON">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="4 7 4 4 20 4 20 7"></polyline>
                                    <line x1="9" y1="20" x2="15" y2="20"></line>
                                    <line x1="12" y1="4" x2="12" y2="20"></line>
                                </svg>
                            </button>
                            <div class="action-divider"></div>
                            <button class="action-btn copy-btn" onclick="copyResult()" title="Copy to clipboard">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <span class="copy-text">Copy</span>
                            </button>
                        </div>
                    </div>
                    <div class="result-body">
                        <!-- Tree View (default, expanded) -->
                        <div class="result-tree" id="result-tree"></div>
                        <!-- Raw JSON View (hidden by default) -->
                        <pre class="result-content result-hidden" id="result-data">{{ result_data }}</pre>
                    </div>
                </div>
                {% elif not success and error_message %}
                <div class="error-panel">
                    <div class="error-header">
                        <div class="error-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            <span>Error Details</span>
                        </div>
                    </div>
                    <div class="error-body">
                        <div class="error-message">{{ error_message }}</div>
                        {% if error_traceback %}
                        <div class="error-traceback">
                            <div class="traceback-label">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <polyline points="4 17 10 11 4 5"></polyline>
                                    <line x1="12" y1="19" x2="20" y2="19"></line>
                                </svg>
                                Stack Trace
                            </div>
                            <pre class="traceback-content">{{ error_traceback }}</pre>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="empty-result-panel">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                        </svg>
                    </div>
                    <div class="empty-text">No result data available</div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="footer">
            <span class="footer-brand">Firefly Software Solutions Inc</span>
            <span class="footer-separator">•</span>
            <span>Made with ❤️</span>
            <span class="footer-separator">•</span>
            <span>Apache 2.0 License</span>
        </footer>
    </div>
    
    <!-- Store raw JSON for tree rendering -->
    <script id="result-json" type="application/json">{{ result_data_json | default('null') | safe }}</script>
    
    {% if inline_scripts %}
    <script>{{ js_content | safe }}</script>
    {% else %}
    <script src="{{ static_url }}/js/completion.js"></script>
    {% endif %}
</body>
</html>
